name: Update Package Managers

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update (e.g., 0.1.6)'
        required: true

# Each package manager update must complete
concurrency:
  group: package-managers-${{ github.event.release.tag_name || github.event.inputs.version }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  update-homebrew:
    name: Update Homebrew Tap
    runs-on: ubuntu-latest
    steps:
      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Download release tarball and get SHA256
        id: sha256
        run: |
          VERSION="${{ steps.version.outputs.tag }}"
          URL="https://github.com/writerslogic/witnessd/archive/refs/tags/${VERSION}.tar.gz"
          curl -sL "$URL" -o release.tar.gz
          SHA256=$(sha256sum release.tar.gz | cut -d' ' -f1)
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA256"

      - name: Checkout homebrew-tap
        uses: actions/checkout@v6
        with:
          repository: writerslogic/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update formula
        run: |
          cd homebrew-tap
          cat > Formula/witnessd.rb << 'EOF'
          # Homebrew formula for witnessd (Rust implementation)
          # To install: brew install writerslogic/tap/witnessd

          class Witnessd < Formula
            desc "Cryptographic authorship witnessing for writers and creators"
            homepage "https://writerslogic.com"
            url "https://github.com/writerslogic/witnessd/archive/refs/tags/${{ steps.version.outputs.tag }}.tar.gz"
            sha256 "${{ steps.sha256.outputs.sha256 }}"
            license "Apache-2.0"
            head "https://github.com/writerslogic/witnessd.git", branch: "main"

            depends_on "rust" => :build

            def install
              cd "rust/witnessd-cli" do
                system "cargo", "build", "--release"
                bin.install "target/release/witnessd-cli" => "witnessd"
              end

              # Install man pages if they exist
              man1.install "docs/man/witnessd.1" if File.exist?("docs/man/witnessd.1")
            end

            def caveats
              <<~EOS
                witnessd has been rewritten in Rust for improved performance and security.

                To get started:

                  1. Initialize witnessd:
                     witnessd init

                  2. Create your first checkpoint:
                     witnessd commit your-document.md -m "Initial draft"

                For more information, see:
                  https://github.com/writerslogic/witnessd

                Privacy note: Keystroke tracking counts keystrokes only.
                It does NOT capture which keys are pressed.
              EOS
            end

            test do
              assert_match "witnessd", shell_output("#{bin}/witnessd --version")
            end
          end
          EOF

      - name: Commit and push
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/witnessd.rb
          git commit -m "Update witnessd to ${{ steps.version.outputs.tag }}" || echo "No changes to commit"
          git push

  update-scoop:
    name: Update Scoop Bucket
    runs-on: ubuntu-latest
    steps:
      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Wait for release assets
        run: |
          # Wait for the Windows zip to be available
          VERSION="${{ steps.version.outputs.tag }}"
          URL="https://github.com/writerslogic/witnessd/releases/download/${VERSION}/witnessd_${VERSION}_x86_64-pc-windows-msvc.zip"
          for i in {1..30}; do
            if curl -sLI "$URL" | grep -q "200"; then
              echo "Asset available"
              break
            fi
            echo "Waiting for release asset... ($i/30)"
            sleep 10
          done

      - name: Get Windows ZIP SHA256
        id: sha256
        run: |
          VERSION="${{ steps.version.outputs.tag }}"
          URL="https://github.com/writerslogic/witnessd/releases/download/${VERSION}/witnessd_${VERSION}_x86_64-pc-windows-msvc.zip"
          curl -sL "$URL" -o windows.zip
          SHA256=$(sha256sum windows.zip | cut -d' ' -f1)
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA256"

      - name: Checkout scoop-bucket
        uses: actions/checkout@v6
        with:
          repository: writerslogic/scoop-bucket
          token: ${{ secrets.SCOOP_BUCKET_TOKEN }}
          path: scoop-bucket

      - name: Update manifest
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"
          SHA256="${{ steps.sha256.outputs.sha256 }}"

          cat > scoop-bucket/witnessd.json << EOF
          {
              "\$schema": "https://raw.githubusercontent.com/ScoopInstaller/Scoop/master/schema.json",
              "version": "${VERSION}",
              "description": "Cryptographic authorship witnessing for writers and creators",
              "homepage": "https://writerslogic.com",
              "license": "Apache-2.0",
              "architecture": {
                  "64bit": {
                      "url": "https://github.com/writerslogic/witnessd/releases/download/${TAG}/witnessd_${TAG}_x86_64-pc-windows-msvc.zip",
                      "hash": "${SHA256}"
                  }
              },
              "bin": [
                  "witnessd-cli.exe",
                  ["witnessd-cli.exe", "witnessd"]
              ],
              "checkver": {
                  "github": "https://github.com/writerslogic/witnessd"
              },
              "autoupdate": {
                  "architecture": {
                      "64bit": {
                          "url": "https://github.com/writerslogic/witnessd/releases/download/v\$version/witnessd_v\$version_x86_64-pc-windows-msvc.zip"
                      }
                  }
              }
          }
          EOF

      - name: Commit and push
        run: |
          cd scoop-bucket
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add witnessd.json
          git commit -m "Update witnessd to ${{ steps.version.outputs.tag }}" || echo "No changes to commit"
          git push
