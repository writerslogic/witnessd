name: Linux Packages

on:
  push:
    tags:
      - 'v*'
  pull_request:
    paths:
      - 'platforms/linux/**'
      - '.github/workflows/linux-packages.yml'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.0)'
        required: false
        default: ''

permissions:
  contents: write
  packages: write

env:
  GO_VERSION: '1.22'

jobs:
  # Build Debian packages
  build-deb:
    name: Build Debian Package
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        arch: [amd64, arm64]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y debhelper devscripts build-essential

      - name: Set version
        id: version
        run: |
          if [[ -n "${{ github.event.inputs.version }}" ]]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            echo "version=0.0.0-dev" >> $GITHUB_OUTPUT
          fi

      - name: Build Debian package
        run: |
          mkdir -p build/deb
          cd build/deb

          # Create source structure
          mkdir -p witnessd-${{ steps.version.outputs.version }}
          rsync -a --exclude='build' --exclude='.git' ../../ witnessd-${{ steps.version.outputs.version }}/

          # Copy and configure debian directory
          cp -r ../../platforms/linux/debian witnessd-${{ steps.version.outputs.version }}/
          sed -i "s/^witnessd (.*)/witnessd (${{ steps.version.outputs.version }}-1)/" \
            witnessd-${{ steps.version.outputs.version }}/debian/changelog

          # Make scripts executable
          chmod +x witnessd-${{ steps.version.outputs.version }}/debian/rules
          chmod +x witnessd-${{ steps.version.outputs.version }}/debian/post*
          chmod +x witnessd-${{ steps.version.outputs.version }}/debian/pre*

          # Create orig tarball
          tar czf witnessd_${{ steps.version.outputs.version }}.orig.tar.gz witnessd-${{ steps.version.outputs.version }}

          # Build
          cd witnessd-${{ steps.version.outputs.version }}
          dpkg-buildpackage -us -uc -b

      - name: Upload Debian package
        uses: actions/upload-artifact@v6
        with:
          name: deb-${{ matrix.arch }}
          path: build/deb/*.deb

  # Build RPM packages
  build-rpm:
    name: Build RPM Package
    runs-on: ubuntu-22.04
    container: fedora:39
    strategy:
      matrix:
        arch: [x86_64, aarch64]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          dnf install -y rpm-build rpmdevtools golang git

      - name: Set version
        id: version
        run: |
          if [[ -n "${{ github.event.inputs.version }}" ]]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            echo "version=0.0.0" >> $GITHUB_OUTPUT
          fi

      - name: Set up RPM build tree
        run: rpmdev-setuptree

      - name: Build RPM package
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # Create source tarball
          mkdir -p witnessd-${VERSION}
          rsync -a --exclude='build' --exclude='.git' . witnessd-${VERSION}/
          tar czf ~/rpmbuild/SOURCES/witnessd-${VERSION}.tar.gz witnessd-${VERSION}

          # Copy spec file and update version
          cp platforms/linux/rpm/witnessd.spec ~/rpmbuild/SPECS/
          sed -i "s/^Version:.*/Version:        ${VERSION}/" ~/rpmbuild/SPECS/witnessd.spec

          # Build
          rpmbuild -ba ~/rpmbuild/SPECS/witnessd.spec

      - name: Upload RPM package
        uses: actions/upload-artifact@v6
        with:
          name: rpm-${{ matrix.arch }}
          path: ~/rpmbuild/RPMS/**/*.rpm

  # Build AppImage
  build-appimage:
    name: Build AppImage
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        arch: [x86_64]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse libfuse2 imagemagick

      - name: Set version
        id: version
        run: |
          if [[ -n "${{ github.event.inputs.version }}" ]]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            echo "version=0.0.0-dev" >> $GITHUB_OUTPUT
          fi

      - name: Build AppImage
        run: |
          chmod +x platforms/linux/scripts/build-appimage.sh
          platforms/linux/scripts/build-appimage.sh ${{ steps.version.outputs.version }} ${{ matrix.arch }}

      - name: Upload AppImage
        uses: actions/upload-artifact@v6
        with:
          name: appimage-${{ matrix.arch }}
          path: build/*.AppImage

  # Test packages in containers
  test-packages:
    name: Test Packages
    needs: [build-deb, build-rpm, build-appimage]
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: build/

      - name: Flatten artifacts
        run: |
          mkdir -p packages
          find build -name "*.deb" -exec mv {} packages/ \;
          find build -name "*.rpm" -exec mv {} packages/ \;
          find build -name "*.AppImage" -exec mv {} packages/ \;
          ls -la packages/

      - name: Test Debian package
        run: |
          docker run --rm -v $PWD/packages:/packages:ro ubuntu:22.04 bash -c "
            apt-get update -qq
            apt-get install -y -qq /packages/*.deb
            witnessd --help || echo 'Help check done'
            witnessctl --help || echo 'Witnessctl help done'
          "

      - name: Test RPM package
        run: |
          docker run --rm -v $PWD/packages:/packages:ro fedora:39 bash -c "
            dnf install -y -q /packages/*.rpm
            witnessd --help || echo 'Help check done'
            witnessctl --help || echo 'Witnessctl help done'
          "

      - name: Test AppImage
        run: |
          docker run --rm -v $PWD/packages:/packages:ro ubuntu:22.04 bash -c "
            apt-get update -qq
            apt-get install -y -qq fuse libfuse2
            chmod +x /packages/*.AppImage
            cd /tmp
            /packages/*.AppImage --appimage-extract > /dev/null 2>&1
            ./squashfs-root/usr/bin/witnessd --help || echo 'Help check done'
          "

  # Upload to release
  release:
    name: Upload to Release
    needs: [test-packages]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-22.04
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Flatten artifacts
        run: |
          mkdir -p release
          find artifacts -name "*.deb" -exec mv {} release/ \;
          find artifacts -name "*.rpm" -exec mv {} release/ \;
          find artifacts -name "*.AppImage" -exec mv {} release/ \;
          ls -la release/

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Build Docker-based package repository (optional)
  repository:
    name: Update Package Repository
    needs: [release]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Set up APT repository
        run: |
          echo "APT repository setup would go here"
          echo "This requires additional infrastructure (S3, GitHub Pages, etc.)"

      - name: Set up YUM repository
        run: |
          echo "YUM repository setup would go here"
          echo "This requires additional infrastructure (S3, GitHub Pages, etc.)"
