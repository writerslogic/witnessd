name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  security-events: write
  pull-requests: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.22'
  GOLANGCI_LINT_VERSION: 'v1.61'
  MIN_COVERAGE: 80

jobs:
  # ============================================================================
  # Signature Verification (main branch only)
  # ============================================================================
  verify-signatures:
    name: Verify Commit Signatures
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect signature
        id: sig
        run: |
          sig=$(git log -1 --pretty=%G?)
          echo "sig=$sig" >> $GITHUB_OUTPUT

      - name: Verify SSH signature (allowed_signers)
        if: steps.sig.outputs.sig != 'N'
        run: |
          git config --global gpg.format ssh
          git config --global gpg.ssh.allowedSignersFile "$(pwd)/allowed_signers"
          git verify-commit HEAD

      - name: Fail on unsigned commit
        if: steps.sig.outputs.sig == 'N'
        run: |
          echo "Commit is unsigned; failing per main-branch policy."
          exit 1

  # ============================================================================
  # Go Linting
  # ============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: ${{ env.GOLANGCI_LINT_VERSION }}
          args: --timeout=10m --out-format=colored-line-number

      - name: Run staticcheck
        run: |
          go install honnef.co/go/tools/cmd/staticcheck@latest
          staticcheck ./...

      - name: Run go vet
        run: go vet ./...

      - name: Check formatting
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "Code is not formatted. Run 'gofmt -w .'"
            gofmt -d .
            exit 1
          fi

      - name: Validate schemas
        run: make validate-schemas

  # ============================================================================
  # Go Unit Tests with Race Detector
  # ============================================================================
  test:
    name: Test (Go ${{ matrix.go }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        go: ['1.21', '1.22']
        include:
          - os: ubuntu-22.04
            go: '1.22'
          - os: ubuntu-24.04
            go: '1.22'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go }}
          cache: true

      - name: Run unit tests with race detector
        run: |
          go test -v -race -coverprofile=coverage-${{ matrix.os }}-${{ matrix.go }}.out -covermode=atomic ./...

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.os }}-${{ matrix.go }}
          path: coverage-*.out
          retention-days: 7

  # ============================================================================
  # Forensics and Topology Tests
  # ============================================================================
  test-forensics:
    name: Forensics Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run forensics tests
        run: go test -v -race ./internal/forensics/...

      - name: Run topology tests
        run: go test -v -race ./internal/witness/...

      - name: Run MMR tests
        run: go test -v -race ./internal/mmr/...

  # ============================================================================
  # IME Tests
  # ============================================================================
  test-ime:
    name: IME Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run IME tests
        run: go test -v -race ./internal/ime/...

      - name: Run jitter tests
        run: go test -v -race ./internal/jitter/...

  # ============================================================================
  # Coverage Reporting
  # ============================================================================
  coverage:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download coverage artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          merge-multiple: true

      - name: Generate coverage report
        run: |
          go test -coverprofile=coverage.out -covermode=atomic ./...
          go tool cover -func=coverage.out -o coverage-summary.txt
          echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat coverage-summary.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check minimum coverage
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Total coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < $MIN_COVERAGE" | bc -l) )); then
            echo "Coverage ${COVERAGE}% is below minimum ${MIN_COVERAGE}%"
            exit 1
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage.out
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  # ============================================================================
  # Build Verification (Multi-Platform)
  # ============================================================================
  build:
    name: Build (${{ matrix.goos }}/${{ matrix.goarch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        goos: [linux, darwin, windows]
        goarch: [amd64, arm64]
        exclude:
          - goos: windows
            goarch: arm64
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build binaries
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: '0'
        run: |
          mkdir -p dist
          BINARY_SUFFIX=""
          if [ "${{ matrix.goos }}" = "windows" ]; then
            BINARY_SUFFIX=".exe"
          fi
          go build -ldflags="-s -w -X main.Version=ci-${{ github.sha }}" \
            -o dist/witnessd-${{ matrix.goos }}-${{ matrix.goarch }}${BINARY_SUFFIX} \
            ./cmd/witnessd
          go build -ldflags="-s -w -X main.Version=ci-${{ github.sha }}" \
            -o dist/witnessctl-${{ matrix.goos }}-${{ matrix.goarch }}${BINARY_SUFFIX} \
            ./cmd/witnessctl

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/
          retention-days: 7

  # ============================================================================
  # macOS Build (Swift App + IME)
  # ============================================================================
  build-macos:
    name: Build macOS (Swift)
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-13
            xcode: '15.2'
          - runner: macos-14
            xcode: '15.4'
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ matrix.xcode }}.app

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Cache Swift build
        uses: actions/cache@v4
        with:
          path: |
            platforms/macos/WitnessdApp/build
            ~/Library/Developer/Xcode/DerivedData
          key: swift-${{ matrix.runner }}-${{ hashFiles('platforms/macos/WitnessdApp/**/*.swift') }}
          restore-keys: |
            swift-${{ matrix.runner }}-

      - name: Build Go library
        run: |
          mkdir -p platforms/macos/WitnessdApp/witnessd/Resources
          CGO_ENABLED=1 go build -ldflags="-s -w" \
            -o platforms/macos/WitnessdApp/witnessd/Resources/witnessd \
            ./cmd/witnessd

      - name: Build macOS App
        run: |
          xcodebuild -project platforms/macos/WitnessdApp/witnessd.xcodeproj \
            -scheme Witness \
            -configuration Release \
            -destination 'platform=macOS' \
            -derivedDataPath platforms/macos/WitnessdApp/build \
            build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Upload macOS app
        uses: actions/upload-artifact@v4
        with:
          name: witnessd-macos-${{ matrix.runner }}
          path: platforms/macos/WitnessdApp/build/Build/Products/Release/
          retention-days: 7

  # ============================================================================
  # macOS IME Build
  # ============================================================================
  build-macos-ime:
    name: Build macOS IME
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build Go library for IME
        run: |
          mkdir -p cmd/witnessd-ime/build
          go build -buildmode=c-archive \
            -o cmd/witnessd-ime/build/libwitnessd.a \
            ./cmd/witnessd-ime

      - name: Upload IME artifacts
        uses: actions/upload-artifact@v4
        with:
          name: witnessd-ime-macos
          path: cmd/witnessd-ime/build/

  # ============================================================================
  # Linux IBus Build
  # ============================================================================
  build-linux-ibus:
    name: Build Linux IBus
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build IBus engine
        run: go build -o witnessd-ibus ./cmd/witnessd-ibus

      - name: Upload IBus artifacts
        uses: actions/upload-artifact@v4
        with:
          name: witnessd-ibus
          path: witnessd-ibus

  # ============================================================================
  # Windows Build
  # ============================================================================
  build-windows:
    name: Build Windows
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        runner: [windows-2019, windows-2022]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build Windows binaries
        shell: pwsh
        run: |
          $env:CGO_ENABLED = "0"
          go build -ldflags="-s -w -X main.Version=ci-${{ github.sha }}" `
            -o dist/witnessd.exe ./cmd/witnessd
          go build -ldflags="-s -w -X main.Version=ci-${{ github.sha }}" `
            -o dist/witnessctl.exe ./cmd/witnessctl

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-windows-${{ matrix.runner }}
          path: dist/
          retention-days: 7

  # ============================================================================
  # Security Scanning
  # ============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run Gosec
        uses: securego/gosec@master
        with:
          args: -fmt sarif -out gosec-results.sarif ./...

      - name: Upload Gosec SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: gosec-results.sarif
          category: gosec

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck -format text ./... || true

      - name: Run nancy (dependency check)
        run: |
          go install github.com/sonatype-nexus-community/nancy@latest
          go list -json -deps ./... | nancy sleuth || true

  # ============================================================================
  # Trivy Container Scanning
  # ============================================================================
  trivy:
    name: Trivy Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (filesystem)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif
          category: trivy

  # ============================================================================
  # Reproducible Build Check
  # ============================================================================
  reproducible-build:
    name: Reproducible Build Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build twice and compare
        run: |
          CGO_ENABLED=0 go build -trimpath -ldflags="-s -w -buildid=" \
            -o witnessd-1 ./cmd/witnessd
          CGO_ENABLED=0 go build -trimpath -ldflags="-s -w -buildid=" \
            -o witnessd-2 ./cmd/witnessd
          echo "Build 1: $(sha256sum witnessd-1)"
          echo "Build 2: $(sha256sum witnessd-2)"
          diff <(sha256sum witnessd-1 | cut -d' ' -f1) \
               <(sha256sum witnessd-2 | cut -d' ' -f1)
          echo "Reproducible build verified!"

  # ============================================================================
  # Benchmarks (optional, for performance tracking)
  # ============================================================================
  benchmarks:
    name: Benchmarks
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run benchmarks
        run: |
          go test -bench=. -benchmem -run=^$ ./internal/mmr/... > mmr-bench.txt
          go test -bench=. -benchmem -run=^$ ./internal/signer/... > signer-bench.txt
          echo "## Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "### MMR Benchmarks" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat mmr-bench.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "### Signer Benchmarks" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat signer-bench.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks
          path: |
            mmr-bench.txt
            signer-bench.txt

  # ============================================================================
  # Quality Gate (all checks must pass)
  # ============================================================================
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs:
      - lint
      - test
      - test-forensics
      - test-ime
      - coverage
      - build
      - build-macos
      - build-windows
      - security
      - trivy
      - reproducible-build
    if: always()
    steps:
      - name: Check all jobs
        run: |
          FAILED=0
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "Lint failed"
            FAILED=1
          fi
          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "Tests failed"
            FAILED=1
          fi
          if [ "${{ needs.test-forensics.result }}" != "success" ]; then
            echo "Forensics tests failed"
            FAILED=1
          fi
          if [ "${{ needs.test-ime.result }}" != "success" ]; then
            echo "IME tests failed"
            FAILED=1
          fi
          if [ "${{ needs.coverage.result }}" != "success" ]; then
            echo "Coverage check failed"
            FAILED=1
          fi
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "Build failed"
            FAILED=1
          fi
          if [ "${{ needs.build-macos.result }}" != "success" ]; then
            echo "macOS build failed"
            FAILED=1
          fi
          if [ "${{ needs.build-windows.result }}" != "success" ]; then
            echo "Windows build failed"
            FAILED=1
          fi
          if [ "${{ needs.security.result }}" != "success" ]; then
            echo "Security scan failed"
            FAILED=1
          fi
          if [ "${{ needs.trivy.result }}" != "success" ]; then
            echo "Trivy scan failed"
            FAILED=1
          fi
          if [ "${{ needs.reproducible-build.result }}" != "success" ]; then
            echo "Reproducible build check failed"
            FAILED=1
          fi
          if [ $FAILED -eq 1 ]; then
            echo "Quality gate failed!"
            exit 1
          fi
          echo "All quality gates passed!"
