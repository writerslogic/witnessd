name: Nightly

on:
  schedule:
    # Run at 2:00 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      full_suite:
        description: 'Run full test suite'
        required: false
        default: 'true'
        type: boolean
      fuzz_duration:
        description: 'Fuzz test duration (e.g., 5m, 30m, 1h)'
        required: false
        default: '10m'
        type: string

permissions:
  contents: read
  security-events: write
  issues: write

env:
  GO_VERSION: '1.22'
  FUZZ_DURATION: ${{ github.event.inputs.fuzz_duration || '10m' }}

jobs:
  # ============================================================================
  # Integration Tests
  # ============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-14, windows-2022]
        go: ['1.21', '1.22']
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go }}
          cache: true

      - name: Run integration tests
        run: |
          go test -v -race -tags=integration -timeout=30m ./...

      - name: Run end-to-end tests
        run: |
          go test -v -tags=e2e -timeout=30m ./tests/...

  # ============================================================================
  # TPM Integration Tests
  # ============================================================================
  tpm-tests:
    name: TPM Integration Tests
    runs-on: ubuntu-latest
    services:
      tpm-simulator:
        image: ghcr.io/salrashid123/tpm2simulator:latest
        ports:
          - 2321:2321
          - 2322:2322
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install TPM2 tools
        run: |
          sudo apt-get update
          sudo apt-get install -y tpm2-tools libtss2-dev

      - name: Wait for TPM simulator
        run: |
          for i in {1..30}; do
            nc -z localhost 2321 && break
            echo "Waiting for TPM simulator..."
            sleep 1
          done

      - name: Run TPM integration tests
        env:
          TPM2TOOLS_TCTI: mssim:host=localhost,port=2321
          WITNESSD_TPM_SIMULATOR: "true"
        run: |
          go test -v -race -tags=tpm_integration -timeout=20m ./internal/tpm/...

      - name: Test TPM attestation flow
        env:
          TPM2TOOLS_TCTI: mssim:host=localhost,port=2321
          WITNESSD_TPM_SIMULATOR: "true"
        run: |
          go test -v -tags=tpm_integration -run TestAttestation ./internal/tpm/...

  # ============================================================================
  # Performance Benchmarks
  # ============================================================================
  benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run benchmarks
        run: |
          mkdir -p benchmark-results

          # MMR benchmarks
          go test -bench=. -benchmem -run=^$ -count=5 \
            ./internal/mmr/... | tee benchmark-results/mmr.txt

          # Signer benchmarks
          go test -bench=. -benchmem -run=^$ -count=5 \
            ./internal/signer/... | tee benchmark-results/signer.txt

          # Crypto benchmarks
          go test -bench=. -benchmem -run=^$ -count=5 \
            ./internal/crypto/... | tee benchmark-results/crypto.txt 2>/dev/null || true

          # Jitter benchmarks
          go test -bench=. -benchmem -run=^$ -count=5 \
            ./internal/jitter/... | tee benchmark-results/jitter.txt

      - name: Compare with baseline
        run: |
          go install golang.org/x/perf/cmd/benchstat@latest
          echo "## Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat benchmark-results/*.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark-results/
          retention-days: 30

      - name: Store benchmark data
        uses: benchmark-action/github-action-benchmark@v1
        with:
          tool: 'go'
          output-file-path: benchmark-results/mmr.txt
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: false
          comment-on-alert: true
          fail-on-alert: false
          alert-threshold: '150%'

  # ============================================================================
  # Memory Profiling
  # ============================================================================
  memory-profiling:
    name: Memory Profiling
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run memory benchmarks
        run: |
          mkdir -p profile-results

          # Generate memory profiles
          go test -bench=BenchmarkMMR -benchmem -memprofile=profile-results/mmr.mem \
            ./internal/mmr/...

          go test -bench=BenchmarkSign -benchmem -memprofile=profile-results/signer.mem \
            ./internal/signer/...

      - name: Analyze memory usage
        run: |
          go tool pprof -text profile-results/mmr.mem > profile-results/mmr-analysis.txt 2>/dev/null || true
          go tool pprof -text profile-results/signer.mem > profile-results/signer-analysis.txt 2>/dev/null || true

          echo "## Memory Analysis" >> $GITHUB_STEP_SUMMARY
          if [ -f profile-results/mmr-analysis.txt ]; then
            echo "### MMR Memory Profile" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -50 profile-results/mmr-analysis.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload memory profiles
        uses: actions/upload-artifact@v4
        with:
          name: memory-profiles
          path: profile-results/
          retention-days: 7

  # ============================================================================
  # Fuzz Testing
  # ============================================================================
  fuzz-tests:
    name: Fuzz Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - package: ./internal/mmr
            fuzz: FuzzMMRAppend
          - package: ./internal/signer
            fuzz: FuzzSign
          - package: ./internal/jitter
            fuzz: FuzzJitterEncode
          - package: ./internal/ime
            fuzz: FuzzKeystrokeAnalysis
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run fuzz tests
        run: |
          go test -fuzz=${{ matrix.target.fuzz }} \
            -fuzztime=${{ env.FUZZ_DURATION }} \
            ${{ matrix.target.package }} 2>&1 || true

      - name: Upload crash artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-crashes-${{ matrix.target.fuzz }}
          path: testdata/fuzz/
          retention-days: 30

  # ============================================================================
  # Extended Fuzz Testing (Weekend only)
  # ============================================================================
  extended-fuzz:
    name: Extended Fuzz Tests
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 2 * * 6' || github.event.inputs.fuzz_duration == '1h'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run extended fuzz tests
        run: |
          # Run each fuzzer for 1 hour on weekends
          for pkg in ./internal/mmr ./internal/signer ./internal/jitter; do
            echo "Fuzzing $pkg..."
            go test -fuzz=Fuzz -fuzztime=1h $pkg 2>&1 || true
          done

  # ============================================================================
  # Dependency Vulnerability Scan
  # ============================================================================
  vulnerability-scan:
    name: Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run govulncheck
        id: govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck -format json ./... > vulns.json 2>&1 || true
          govulncheck ./... 2>&1 | tee vuln-report.txt || true

      - name: Run nancy
        run: |
          go install github.com/sonatype-nexus-community/nancy@latest
          go list -json -deps ./... | nancy sleuth --output json > nancy-report.json 2>&1 || true

      - name: Run Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'trivy-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Generate vulnerability summary
        run: |
          echo "## Vulnerability Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "### govulncheck" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat vuln-report.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Create issue for vulnerabilities
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let vulnReport = '';
            try {
              vulnReport = fs.readFileSync('vuln-report.txt', 'utf8');
            } catch (e) {
              vulnReport = 'Unable to read vulnerability report';
            }

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security,automated',
              state: 'open'
            });

            const existingIssue = issues.data.find(i => i.title.includes('Nightly Security Scan'));

            const body = `## Nightly Security Scan Found Vulnerabilities

            **Date:** ${new Date().toISOString()}

            ### Vulnerability Report
            \`\`\`
            ${vulnReport.substring(0, 60000)}
            \`\`\`

            Please review and address these vulnerabilities.
            `;

            if (existingIssue) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '[Automated] Nightly Security Scan Found Vulnerabilities',
                body: body,
                labels: ['security', 'automated']
              });
            }

      - name: Upload vulnerability reports
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-reports
          path: |
            vulns.json
            nancy-report.json
            trivy-results.json
          retention-days: 30

  # ============================================================================
  # License Compliance
  # ============================================================================
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install go-licenses
        run: go install github.com/google/go-licenses@latest

      - name: Check licenses
        run: |
          go-licenses check ./... 2>&1 | tee license-report.txt || true
          go-licenses csv ./... > licenses.csv 2>&1 || true

      - name: Generate license summary
        run: |
          echo "## License Summary" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat license-report.txt >> $GITHUB_STEP_SUMMARY || echo "No issues found"
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-reports
          path: |
            license-report.txt
            licenses.csv
          retention-days: 30

  # ============================================================================
  # Code Quality Metrics
  # ============================================================================
  code-quality:
    name: Code Quality Metrics
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Calculate cyclomatic complexity
        run: |
          go install github.com/fzipp/gocyclo/cmd/gocyclo@latest
          gocyclo -over 15 . > complexity-report.txt 2>&1 || true

          echo "## Cyclomatic Complexity" >> $GITHUB_STEP_SUMMARY
          echo "Functions with complexity > 15:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat complexity-report.txt >> $GITHUB_STEP_SUMMARY || echo "None found"
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Count lines of code
        run: |
          go install github.com/hhatto/gocloc/cmd/gocloc@latest
          gocloc . --output-type=json > loc-report.json 2>/dev/null || true
          gocloc . | tee loc-report.txt

          echo "## Lines of Code" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat loc-report.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload quality reports
        uses: actions/upload-artifact@v4
        with:
          name: quality-reports
          path: |
            complexity-report.txt
            loc-report.*
          retention-days: 30

  # ============================================================================
  # Build Snapshot
  # ============================================================================
  nightly-build:
    name: Nightly Build
    runs-on: ubuntu-latest
    needs: [integration-tests, benchmarks, vulnerability-scan]
    if: always() && needs.integration-tests.result != 'failure'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          install-only: true

      - name: Build snapshot
        run: |
          goreleaser release --snapshot --clean

      - name: Upload nightly artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nightly-${{ github.run_number }}
          path: dist/
          retention-days: 7

  # ============================================================================
  # Nightly Summary
  # ============================================================================
  summary:
    name: Nightly Summary
    runs-on: ubuntu-latest
    needs:
      - integration-tests
      - tpm-tests
      - benchmarks
      - fuzz-tests
      - vulnerability-scan
      - license-check
      - code-quality
      - nightly-build
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# Nightly Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TPM Tests | ${{ needs.tpm-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Benchmarks | ${{ needs.benchmarks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Fuzz Tests | ${{ needs.fuzz-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Vulnerability Scan | ${{ needs.vulnerability-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Check | ${{ needs.license-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Nightly Build | ${{ needs.nightly-build.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: contains(needs.*.result, 'failure')
        uses: actions/github-script@v7
        with:
          script: |
            const failedJobs = [];
            if ('${{ needs.integration-tests.result }}' === 'failure') failedJobs.push('Integration Tests');
            if ('${{ needs.tpm-tests.result }}' === 'failure') failedJobs.push('TPM Tests');
            if ('${{ needs.benchmarks.result }}' === 'failure') failedJobs.push('Benchmarks');
            if ('${{ needs.fuzz-tests.result }}' === 'failure') failedJobs.push('Fuzz Tests');
            if ('${{ needs.vulnerability-scan.result }}' === 'failure') failedJobs.push('Vulnerability Scan');
            if ('${{ needs.nightly-build.result }}' === 'failure') failedJobs.push('Nightly Build');

            console.log(`Nightly build failed: ${failedJobs.join(', ')}`);
            // Add Slack/Discord notification here if needed
