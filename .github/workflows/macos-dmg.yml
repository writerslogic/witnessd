name: macOS DMG Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.0)'
        required: false
        default: ''
      skip_notarization:
        description: 'Skip notarization (for testing)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  id-token: write

env:
  APP_NAME: Witnessd
  XCODE_VERSION: '15.0'
  MACOS_DEPLOYMENT_TARGET: '13.0'

jobs:
  build-dmg:
    name: Build macOS DMG
    runs-on: macos-14  # M1 runner for ARM64 native builds
    outputs:
      version: ${{ steps.version.outputs.version }}
      dmg_name: ${{ steps.version.outputs.dmg_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
          else
            VERSION="$(git describe --tags --always --dirty | sed 's/^v//')"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "dmg_name=Witnessd-${VERSION}.dmg" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"

      - name: Select Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer
          xcodebuild -version

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Install dependencies
        run: |
          brew install librsvg create-dmg

      - name: Import Apple Developer Certificate
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12
          security import certificate.p12 -k "$KEYCHAIN_PATH" \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security
          rm certificate.p12

          # Set keychain ACL
          security set-key-partition-list -S apple-tool:,apple:,codesign: \
            -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Add to search list
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain

          # Verify certificate
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

      - name: Configure notarization credentials
        env:
          APPLE_API_KEY_ID: ${{ secrets.APPLE_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APPLE_ISSUER_ID }}
          APPLE_API_KEY_CONTENT: ${{ secrets.APPLE_PRIVATE_KEY }}
        run: |
          # Store API key for notarytool
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$APPLE_API_KEY_CONTENT" > ~/.appstoreconnect/private_keys/AuthKey_${APPLE_API_KEY_ID}.p8
          chmod 600 ~/.appstoreconnect/private_keys/AuthKey_${APPLE_API_KEY_ID}.p8

          # Store credentials in keychain for notarytool
          xcrun notarytool store-credentials "notarytool" \
            --key ~/.appstoreconnect/private_keys/AuthKey_${APPLE_API_KEY_ID}.p8 \
            --key-id "$APPLE_API_KEY_ID" \
            --issuer "$APPLE_API_ISSUER_ID"

      - name: Build witnessd CLI (Universal Binary)
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          cd platforms/macos/WitnessdApp/scripts
          chmod +x build-app.sh
          ./build-app.sh --universal

      - name: Build SwiftUI App
        env:
          SIGNING_IDENTITY: ${{ secrets.APPLE_DEVELOPER_ID }}
        run: |
          cd platforms/macos/WitnessdApp/scripts
          chmod +x build-swiftui.sh
          ./build-swiftui.sh build

      - name: Code Sign App
        env:
          SIGNING_IDENTITY: ${{ secrets.APPLE_DEVELOPER_ID }}
        run: |
          cd platforms/macos/WitnessdApp/scripts
          chmod +x codesign.sh
          ./codesign.sh sign

      - name: Notarize App
        if: ${{ github.event.inputs.skip_notarization != 'true' }}
        env:
          NOTARYTOOL_PROFILE: notarytool
        run: |
          cd platforms/macos/WitnessdApp/scripts
          chmod +x notarize.sh
          ./notarize.sh notarize

      - name: Create DMG
        env:
          VERSION: ${{ steps.version.outputs.version }}
          SIGNING_IDENTITY: ${{ secrets.APPLE_DEVELOPER_ID }}
          NOTARYTOOL_PROFILE: notarytool
        run: |
          cd platforms/macos/WitnessdApp/scripts
          chmod +x create-dmg.sh

          if [ "${{ github.event.inputs.skip_notarization }}" == "true" ]; then
            ./create-dmg.sh create --no-notarize --version "$VERSION"
          else
            ./create-dmg.sh release --version "$VERSION"
          fi

      - name: Generate checksums
        run: |
          cd platforms/macos/WitnessdApp/build
          shasum -a 256 *.dmg > checksums-macos.txt
          shasum -a 512 *.dmg >> checksums-macos.txt
          cat checksums-macos.txt

      - name: Verify DMG
        run: |
          cd platforms/macos/WitnessdApp/build
          DMG_FILE="${{ steps.version.outputs.dmg_name }}"

          # Verify code signature
          codesign --verify --verbose "$DMG_FILE"

          # Verify Gatekeeper (if notarized)
          if [ "${{ github.event.inputs.skip_notarization }}" != "true" ]; then
            spctl --assess --type open --context context:primary-signature "$DMG_FILE" || true
          fi

          # Show file info
          ls -lh "$DMG_FILE"

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: witnessd-macos-dmg
          path: |
            platforms/macos/WitnessdApp/build/*.dmg
            platforms/macos/WitnessdApp/build/*.sha256
            platforms/macos/WitnessdApp/build/checksums-macos.txt
          retention-days: 30

      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd platforms/macos/WitnessdApp/build
          gh release upload ${{ github.ref_name }} \
            "${{ steps.version.outputs.dmg_name }}" \
            "Witnessd-${{ steps.version.outputs.version }}.sha256" \
            checksums-macos.txt \
            --clobber

      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain "$RUNNER_TEMP/app-signing.keychain-db" || true
          rm -rf ~/.appstoreconnect || true

  # Build Intel-only DMG for older Macs
  build-dmg-intel:
    name: Build macOS DMG (Intel)
    runs-on: macos-13  # Intel runner
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "dmg_name=Witnessd-${VERSION}-intel.dmg" >> $GITHUB_OUTPUT

      - name: Select Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer || \
          sudo xcode-select -s /Applications/Xcode_14.3.1.app/Contents/Developer
          xcodebuild -version

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Install dependencies
        run: |
          brew install librsvg create-dmg

      - name: Import Apple Developer Certificate
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12
          security import certificate.p12 -k "$KEYCHAIN_PATH" \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign
          rm certificate.p12

          security set-key-partition-list -S apple-tool:,apple:,codesign: \
            -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain

      - name: Configure notarization
        env:
          APPLE_API_KEY_ID: ${{ secrets.APPLE_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APPLE_ISSUER_ID }}
          APPLE_API_KEY_CONTENT: ${{ secrets.APPLE_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$APPLE_API_KEY_CONTENT" > ~/.appstoreconnect/private_keys/AuthKey_${APPLE_API_KEY_ID}.p8
          chmod 600 ~/.appstoreconnect/private_keys/AuthKey_${APPLE_API_KEY_ID}.p8

          xcrun notarytool store-credentials "notarytool" \
            --key ~/.appstoreconnect/private_keys/AuthKey_${APPLE_API_KEY_ID}.p8 \
            --key-id "$APPLE_API_KEY_ID" \
            --issuer "$APPLE_API_ISSUER_ID"

      - name: Build witnessd CLI (Intel only)
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          cd platforms/macos/WitnessdApp/scripts
          chmod +x build-app.sh
          ./build-app.sh --amd64

      - name: Build and Package
        env:
          VERSION: ${{ steps.version.outputs.version }}
          SIGNING_IDENTITY: ${{ secrets.APPLE_DEVELOPER_ID }}
          NOTARYTOOL_PROFILE: notarytool
        run: |
          cd platforms/macos/WitnessdApp/scripts
          chmod +x build-swiftui.sh codesign.sh notarize.sh create-dmg.sh

          ./build-swiftui.sh build
          ./codesign.sh sign
          ./notarize.sh notarize
          ./create-dmg.sh release --version "$VERSION"

          # Rename to indicate Intel-only
          mv "../build/Witnessd-${VERSION}.dmg" "../build/Witnessd-${VERSION}-intel.dmg"
          mv "../build/Witnessd-${VERSION}.sha256" "../build/Witnessd-${VERSION}-intel.sha256"

      - name: Upload to Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd platforms/macos/WitnessdApp/build
          gh release upload ${{ github.ref_name }} \
            "Witnessd-${{ steps.version.outputs.version }}-intel.dmg" \
            "Witnessd-${{ steps.version.outputs.version }}-intel.sha256" \
            --clobber

      - name: Cleanup
        if: always()
        run: |
          security delete-keychain "$RUNNER_TEMP/app-signing.keychain-db" || true
          rm -rf ~/.appstoreconnect || true

  # Verification job
  verify-release:
    name: Verify Release Artifacts
    needs: [build-dmg, build-dmg-intel]
    runs-on: macos-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: witnessd-macos-dmg
          path: artifacts/

      - name: Verify checksums
        run: |
          cd artifacts
          echo "=== Verifying checksums ==="
          cat checksums-macos.txt

          # Verify SHA256
          for dmg in *.dmg; do
            echo "Verifying: $dmg"
            expected=$(grep "$dmg" checksums-macos.txt | head -1 | awk '{print $1}')
            actual=$(shasum -a 256 "$dmg" | awk '{print $1}')
            if [ "$expected" == "$actual" ]; then
              echo "  SHA256: PASS"
            else
              echo "  SHA256: FAIL"
              exit 1
            fi
          done

      - name: Test DMG mount
        run: |
          cd artifacts
          DMG_FILE=$(ls *.dmg | head -1)
          echo "Testing mount of: $DMG_FILE"

          # Mount DMG
          hdiutil attach "$DMG_FILE" -mountpoint /tmp/test-mount

          # Check contents
          ls -la /tmp/test-mount/
          test -d "/tmp/test-mount/Witnessd.app"
          test -L "/tmp/test-mount/Applications"

          # Check app structure
          ls -la "/tmp/test-mount/Witnessd.app/Contents/"
          test -f "/tmp/test-mount/Witnessd.app/Contents/MacOS/Witnessd"
          test -f "/tmp/test-mount/Witnessd.app/Contents/Resources/witnessd"

          # Unmount
          hdiutil detach /tmp/test-mount

          echo "DMG verification passed!"
