{
  "$schema": "https://raw.githubusercontent.com/writerslogic/witnessd/main/docs/schema/tpm-policy-v1.schema.json",
  "version": "1.1.0",
  "description": "TPM 2.0 Policy Configuration for witnessd Ed25519 signing key protection",

  "architecture": {
    "summary": "TPM seals Ed25519 key; signing occurs in software",
    "rationale": "TPM 2.0 does not support Ed25519 natively (only NIST curves P-256/P-384/P-521)",
    "approach": [
      "1. Generate Ed25519 keypair in software",
      "2. Seal private key bytes to TPM as opaque data (bound to PCRs)",
      "3. On signing: unseal key from TPM (requires PCR match)",
      "4. Perform Ed25519 signature in software with unsealed key",
      "5. Zero unsealed key material from memory immediately after use"
    ],
    "security_properties": {
      "key_at_rest": "Encrypted by TPM storage key, bound to PCR state",
      "key_in_use": "Plaintext only during signing operation in process memory",
      "extraction_resistance": "Key cannot be extracted without matching PCR values"
    }
  },

  "policy": {
    "name": "witnessd-signing-key",
    "description": "Policy for sealing Ed25519 private key to TPM PCRs",

    "pcr_selection": {
      "hash_algorithm": "sha256",
      "pcrs": [
        {
          "index": 0,
          "description": "SRTM, BIOS, and Platform Extensions",
          "required": true,
          "note": "Measures boot firmware integrity"
        },
        {
          "index": 4,
          "description": "Boot Manager / MBR",
          "required": true,
          "note": "Measures bootloader integrity - critical for detecting boot-level attacks"
        },
        {
          "index": 7,
          "description": "Secure Boot State",
          "required": true,
          "note": "Ensures Secure Boot is enabled and unchanged"
        }
      ],
      "excluded": {
        "note": "These PCRs are intentionally excluded due to volatility",
        "pcrs": [
          {
            "index": 1,
            "reason": "Platform Configuration changes with BIOS updates, memory changes"
          },
          {
            "index": 2,
            "reason": "Option ROM Code changes when adding/removing PCI devices"
          },
          {
            "index": 3,
            "reason": "Option ROM Configuration too hardware-specific and volatile"
          }
        ]
      }
    },

    "authorization": {
      "type": "policy_session",
      "commands": [
        "TPM2_PolicyPCR",
        "TPM2_PolicyAuthValue"
      ],
      "password_required": false,
      "note": "Sealed data is released only when PCR values match policy"
    },

    "sealed_object": {
      "type": "sealed_data",
      "content": "Ed25519 private key (32 bytes seed)",
      "parent_key": {
        "type": "storage_key",
        "algorithm": "ecc",
        "curve": "nist_p256",
        "note": "TPM-native key that encrypts the sealed Ed25519 key"
      },
      "attributes": {
        "fixed_tpm": true,
        "fixed_parent": true,
        "user_with_auth": false,
        "no_da": false
      }
    },

    "signing": {
      "algorithm": "ed25519",
      "key_size": 256,
      "execution": "software",
      "note": "Signing performed in software after TPM unseals the key"
    }
  },

  "attestation": {
    "description": "TPM quotes prove platform state; separate from Ed25519 document signing",

    "attestation_key": {
      "type": "TPM-resident RSA key",
      "algorithm": "rsa",
      "key_size": 2048,
      "scheme": "rsassa_pkcs1_sha256",
      "tpm_alg_id": "TPM_ALG_RSASSA",
      "hash_alg": "TPM_ALG_SHA256",
      "note": "AK is a TPM-native key (RSA), distinct from the sealed Ed25519 signing key",
      "cli_create": "tpm2_createak -C ek.ctx -c ak.ctx -G rsa2048:rsassa:sha256 -u ak.pub -n ak.name"
    },

    "quote": {
      "enabled": true,
      "pcr_selection": [0, 4, 7],
      "hash_algorithm": "sha256",
      "signing_key": "attestation_key",
      "note": "Quote signed by TPM-resident AK (RSA), proving PCR state at quote time",
      "cli_commands": [
        "# Generate quote with nonce for freshness",
        "tpm2_quote -c ak.ctx -l sha256:0,4,7 -q <nonce_hex> -m quote.msg -s quote.sig -o pcr_values.bin",
        "",
        "# Verify quote signature (using AK public key)",
        "tpm2_checkquote -u ak.pub -m quote.msg -s quote.sig -f pcr_values.bin -q <nonce_hex>"
      ]
    },

    "ak_certificate": {
      "description": "Attestation Key certificate chain for TPM identity",
      "validation": "ek_certificate_chain",
      "note": "Enables hardware-bound identity verification via manufacturer cert chain"
    }
  },

  "recovery": {
    "description": "Recovery options if PCR values change (e.g., firmware update)",

    "reseal": {
      "description": "Generate new sealed key with updated PCR values",
      "requires": ["owner_auth", "existing_key_backup"],
      "cli_commands": [
        "# 1. Read current PCR values for new policy",
        "tpm2_pcrread sha256:0,4,7 -o pcr_values.bin",
        "",
        "# 2. Create new PCR policy with current values",
        "tpm2_createpolicy --policy-pcr -l sha256:0,4,7 -f pcr_values.bin -L policy.digest",
        "",
        "# 3. Create primary storage key (if not exists)",
        "tpm2_createprimary -C o -g sha256 -G ecc256 -c primary.ctx",
        "",
        "# 4. Seal Ed25519 key with new PCR policy",
        "tpm2_create -C primary.ctx -i ed25519_seed.bin -u sealed.pub -r sealed.priv -L policy.digest -a 'fixedtpm|fixedparent'",
        "",
        "# 5. Load sealed object",
        "tpm2_load -C primary.ctx -u sealed.pub -r sealed.priv -c sealed.ctx",
        "",
        "# 6. Persist handle (optional)",
        "tpm2_evictcontrol -C o -c sealed.ctx 0x81000001"
      ]
    },

    "unseal_test": {
      "description": "Verify key can be unsealed with current PCR state",
      "cli_commands": [
        "# Start policy session",
        "tpm2_startauthsession --policy-session -S session.ctx",
        "",
        "# Satisfy PCR policy",
        "tpm2_policypcr -S session.ctx -l sha256:0,4,7",
        "",
        "# Unseal (outputs key material - handle securely!)",
        "tpm2_unseal -c sealed.ctx -p session:session.ctx -o unsealed_key.bin",
        "",
        "# Clean up session",
        "tpm2_flushcontext session.ctx"
      ]
    },

    "backup_restore": {
      "description": "Restore from encrypted software backup when TPM is unavailable",
      "requires": ["backup_passphrase", "backup_file"],
      "note": "Backup is AES-256-GCM encrypted Ed25519 seed, stored separately from TPM"
    }
  },

  "audit": {
    "log_paths": {
      "linux": "/var/log/witnessd/tpm-audit.log",
      "darwin": "~/Library/Logs/witnessd/tpm-audit.log",
      "windows": "%LOCALAPPDATA%\\witnessd\\logs\\tpm-audit.log"
    },
    "events": [
      "key_seal",
      "key_unseal",
      "quote_generation",
      "policy_failure",
      "pcr_mismatch"
    ]
  },

  "compatibility": {
    "minimum_tpm_version": "2.0",
    "required_commands": {
      "key_sealing": [
        "TPM2_CreatePrimary",
        "TPM2_Create",
        "TPM2_Load",
        "TPM2_Unseal",
        "TPM2_PolicyPCR",
        "TPM2_StartAuthSession",
        "TPM2_FlushContext"
      ],
      "attestation": [
        "TPM2_Quote",
        "TPM2_CreatePrimary",
        "TPM2_PCR_Read"
      ],
      "optional": [
        "TPM2_EvictControl",
        "TPM2_NV_DefineSpace",
        "TPM2_NV_Write"
      ],
      "note": "TPM2_Quote signs internally with AK; no separate TPM2_Sign needed. Ed25519 document signing is in software."
    },
    "tested_implementations": [
      "Intel PTT",
      "AMD fTPM",
      "Infineon SLB9670",
      "STMicroelectronics ST33",
      "Nuvoton NPCT75x",
      "IBM TPM 2.0 Simulator"
    ]
  }
}
