{
  "$schema": "https://raw.githubusercontent.com/writerslogic/witnessd/main/docs/schema/attestation-v1.schema.json",
  "version": "1.0.0",
  "description": "TPM Quote attestation template for hardware-bound MMR root commitments",

  "attestation": {
    "type": "tpm2_quote",
    "description": "Hardware-bound timestamp proving MMR root was signed on specific device",

    "quote_structure": {
      "magic": "0xff544347",
      "qualified_signer": {
        "description": "Name of the signing key (AK)",
        "type": "tpm2b_name",
        "note": "Derived from AK public key, uniquely identifies this TPM"
      },
      "extra_data": {
        "description": "MMR root hash being attested",
        "type": "tpm2b_data",
        "max_size": 64,
        "content": {
          "mmr_root": "SHA256 hash of MMR peak bag",
          "timestamp": "Unix timestamp in nanoseconds",
          "mmr_size": "Number of nodes in MMR"
        }
      },
      "clock_info": {
        "clock": "TPM clock value (milliseconds since reset)",
        "reset_count": "Number of TPM resets",
        "restart_count": "Number of TPM restarts",
        "safe": "Whether clock is guaranteed safe"
      },
      "firmware_version": "TPM firmware version",
      "pcr_select": {
        "hash": "sha256",
        "pcrs": [0, 1, 2, 3, 7]
      },
      "pcr_digest": "SHA256 of selected PCR values"
    },

    "signature": {
      "algorithm": "rsassa",
      "hash": "sha256",
      "description": "RSA signature over TPMS_ATTEST structure"
    }
  },

  "identity_binding": {
    "endorsement_key": {
      "type": "ek_certificate",
      "description": "TPM manufacturer certificate binding TPM to hardware",
      "validation": [
        "Verify EK certificate chain to manufacturer root",
        "Check certificate not revoked",
        "Confirm TPM model is trusted"
      ]
    },
    "attestation_key": {
      "type": "ak_certificate",
      "description": "Key used for signing quotes",
      "creation": "Created under EK, certifies TPM identity"
    }
  },

  "evidence_packet": {
    "description": "Complete evidence bundle for verification",
    "fields": {
      "quote": {
        "type": "base64",
        "description": "TPMS_ATTEST structure"
      },
      "signature": {
        "type": "base64",
        "description": "Quote signature from AK"
      },
      "pcr_values": {
        "type": "object",
        "description": "Actual PCR values at quote time"
      },
      "ak_public": {
        "type": "base64",
        "description": "AK public key for signature verification"
      },
      "ek_certificate": {
        "type": "pem",
        "description": "EK certificate chain (optional, for identity binding)"
      },
      "mmr_proof": {
        "type": "object",
        "description": "MMR inclusion proof for witnessed file"
      },
      "metadata": {
        "timestamp_ns": "int64",
        "device_id": "uuid",
        "witnessd_version": "string"
      }
    }
  },

  "verification_steps": [
    {
      "step": 1,
      "name": "Verify Quote Signature",
      "description": "Verify RSA signature over TPMS_ATTEST using AK public key",
      "failure": "Quote was not signed by claimed TPM"
    },
    {
      "step": 2,
      "name": "Verify PCR Digest",
      "description": "Hash provided PCR values and compare to pcr_digest in quote",
      "failure": "PCR values do not match quote digest"
    },
    {
      "step": 3,
      "name": "Verify Extra Data",
      "description": "Confirm extra_data contains expected MMR root hash",
      "failure": "MMR root does not match attested value"
    },
    {
      "step": 4,
      "name": "Validate PCR Policy",
      "description": "Check PCR values match expected boot state (optional)",
      "failure": "System boot state differs from policy"
    },
    {
      "step": 5,
      "name": "Verify TPM Identity (Optional)",
      "description": "Validate EK certificate chain to manufacturer",
      "failure": "Cannot confirm TPM is genuine hardware"
    },
    {
      "step": 6,
      "name": "Verify MMR Inclusion",
      "description": "Verify file hash is included in attested MMR root",
      "failure": "File was not witnessed at claimed time"
    }
  ],

  "legal_considerations": {
    "fre_902_13": {
      "description": "Federal Rules of Evidence 902(13) - Self-Authenticating Electronic Records",
      "requirements": [
        "Record generated by electronic process or system",
        "Process produces accurate result (demonstrated by TPM certification)",
        "Certification by qualified person (or automated attestation)",
        "Written notice to opposing party (attestation packet serves this)"
      ]
    },
    "eidas_2_0": {
      "description": "EU Electronic Identification and Trust Services",
      "level": "Advanced Electronic Signature",
      "requirements": [
        "Uniquely linked to signatory (device-bound via TPM)",
        "Capable of identifying signatory (EK certificate chain)",
        "Created using data under signatory's sole control (TPM-sealed key)",
        "Linked to data in detectable manner (MMR binding)"
      ],
      "note": "Qualified signature requires QSCD; TPM may qualify in some jurisdictions"
    }
  },

  "example_output": {
    "description": "Example attestation output (values truncated)",
    "attestation": {
      "quote": "//5UQ0cAIgAL...",
      "signature": "ABQACwEA...",
      "pcr_values": {
        "0": "3d458cfe55cc03ea...",
        "7": "65e2ff7e3eab8d7c..."
      },
      "ak_public": "AToAAQALAAMA...",
      "mmr_proof": {
        "leaf_hash": "abc123...",
        "leaf_index": 42,
        "peaks": ["def456...", "789abc..."],
        "mmr_size": 100
      },
      "metadata": {
        "timestamp_ns": 1737772800000000000,
        "device_id": "550e8400-e29b-41d4-a716-446655440000",
        "witnessd_version": "0.1.0"
      }
    }
  }
}
